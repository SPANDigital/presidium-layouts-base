{{/* Root Validator - common validation lifecycle for all types */}}
{{/* Analogous to Hugo's baseof.html - provides base functionality that all validators extend */}}

{{- $value := .value -}}
{{- $rules := .rules -}}
{{- $fieldName := .fieldName -}}
{{- $pageParams := .pageParams -}}
{{- $ctx := .context -}}
{{- $errors := slice -}}
{{- $result := dict -}}

{{/* Step 1: Check if field exists (use isset to handle empty arrays correctly) */}}
{{- $fieldExists := isset $pageParams $fieldName -}}

{{/* Step 2: Check required fields */}}
{{- if $rules.required -}}
  {{- if not $fieldExists -}}
    {{- $message := $rules.validation_message | default (printf "%s is required" $fieldName) -}}
    {{- $errors = $errors | append $message -}}
    {{- $result = dict "valid" false "errors" $errors -}}
  {{- end -}}
{{- end -}}

{{/* Step 3: Skip validation if field not present and not required */}}
{{- if and (not $fieldExists) (eq (len $errors) 0) -}}
  {{- $result = dict "valid" true "errors" slice -}}
{{- end -}}

{{/* Steps 4-6: Only execute if we haven't already determined result */}}
{{- if not $result.valid -}}
  {{- if and (eq (len $errors) 0) $fieldExists -}}
    {{/* Step 3: Determine validator path based on type */}}
    {{- $fieldType := $rules.type -}}
    {{- $validatorPath := "" -}}

    {{- $formatTypes := slice "text" "email" "date" "datetime" "option" -}}
    {{- if in $formatTypes $fieldType -}}
      {{- $validatorPath = printf "frontmatter/validators/formats/%s.html" $fieldType -}}
    {{- else -}}
      {{- $validatorPath = printf "frontmatter/validators/types/%s.html" $fieldType -}}
    {{- end -}}

    {{/* Step 4: Delegate to type-specific validator */}}
    {{- partial $validatorPath (dict "value" $value "rules" $rules "fieldName" $fieldName "context" $ctx) -}}
    {{- $validationResult := $ctx.Scratch.Get "type_validation_result" -}}

    {{/* Step 5: Format errors using validation_message if needed */}}
    {{- if not $validationResult.valid -}}
      {{- if $rules.validation_message -}}
        {{/* Use custom validation message if provided */}}
        {{- $errors = $errors | append $rules.validation_message -}}
      {{- else -}}
        {{/* Use errors from type validator */}}
        {{- $errors = $validationResult.errors -}}
      {{- end -}}
    {{- end -}}

    {{- $result = dict "valid" (eq (len $errors) 0) "errors" $errors -}}
  {{- end -}}
{{- end -}}

{{/* Store result in scratch for retrieval by orchestrator */}}
{{- $ctx.Scratch.Set "validation_result" $result -}}
