{{- $ctx := . -}}
{{- $namespace := .Site.Params.data.namespace | default "presidium" -}}

{{/* Load merged config from Hugo */}}
{{- $mergedConfig := .Site.Params.frontmatter | default dict -}}

{{/* Load schema types for enrichment */}}
{{- $rootSchema := index .Site.Data.schemas.frontmatter "root" | default dict -}}
{{- $typeSchemas := index .Site.Data.schemas.frontmatter "types" | default dict -}}
{{- $formatSchemas := index .Site.Data.schemas.frontmatter "formats" | default dict -}}

{{/* Read raw base config */}}
{{- $baseConfig := dict -}}
{{- $basePath := "config/_default/frontmatter/params.yaml" -}}
{{- if fileExists $basePath -}}
  {{- $baseContent := os.ReadFile $basePath -}}
  {{- if $baseContent -}}
    {{- $parsed := transform.Unmarshal $baseContent -}}
    {{- if $parsed -}}
      {{- $baseConfig = index $parsed "frontmatter" | default dict -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{/* Detect module name for attribution */}}
{{- $moduleName := "module" -}}
{{- if .Site.Params.module -}}
  {{- $moduleName = .Site.Params.module.name | default "module" -}}
{{- end -}}

{{/* Initialize YAML output */}}
{{- $yaml := slice -}}

{{/* Header */}}
{{- $yaml = $yaml | append "# Consolidated Frontmatter Schema" -}}
{{- $yaml = $yaml | append (printf "# Generated: %s" (now.Format "2006-01-02T15:04:05Z07:00")) -}}
{{- $yaml = $yaml | append "#" -}}
{{- $yaml = $yaml | append "# Configuration Sources:" -}}
{{- $yaml = $yaml | append (printf "#   %s (module)" $moduleName) -}}
{{- $yaml = $yaml | append "#   github.com/spandigital/presidium-layouts-base (indirect)" -}}
{{- $yaml = $yaml | append "" -}}
{{- $yaml = $yaml | append "frontmatter:" -}}

{{/* Process each field */}}
{{- range $fieldName, $fieldRules := $mergedConfig -}}
  {{- $fieldType := $fieldRules.type | default "string" -}}
  {{- $fieldFormat := $fieldRules.format | default "" -}}
  
  {{/* Start with merged rules */}}
  {{- $enriched := $fieldRules -}}
  
  {{/* Apply root defaults */}}
  {{- range $key, $value := $rootSchema -}}
    {{- if not (isset $enriched $key) -}}
      {{/* Skip type placeholder values */}}
      {{- if not (in (slice "string" "number" "boolean" "array" "object") $value) -}}
        {{- $enriched = merge $enriched (dict $key $value) -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
  
  {{/* Apply type defaults */}}
  {{- if $fieldFormat -}}
    {{- $formatDefaults := index $formatSchemas $fieldFormat | default dict -}}
    {{- range $key, $value := $formatDefaults -}}
      {{- if not (isset $enriched $key) -}}
        {{/* Skip type placeholder values */}}
        {{- if not (in (slice "string" "number" "boolean" "array" "object") $value) -}}
          {{- $enriched = merge $enriched (dict $key $value) -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
  
  {{- $typeDefaults := index $typeSchemas $fieldType | default dict -}}
  {{- range $key, $value := $typeDefaults -}}
    {{- if not (isset $enriched $key) -}}
      {{/* Skip type placeholder values */}}
      {{- if not (in (slice "string" "number" "boolean" "array" "object") $value) -}}
        {{- $enriched = merge $enriched (dict $key $value) -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
  
  {{/* Detect field source */}}
  {{- $fieldSource := $moduleName -}}
  {{- $fieldTier := "module" -}}
  {{- if isset $baseConfig $fieldName -}}
    {{- $fieldSource = "github.com/spandigital/presidium-layouts-base" -}}
    {{- $fieldTier = "indirect" -}}
  {{- end -}}
  
  {{/* Add field with attribution comment */}}
  {{- $yaml = $yaml | append (printf "  %s:  # %s (%s)" $fieldName $fieldSource $fieldTier) -}}
  
  {{/* Process attributes in consistent order */}}
  {{- $orderedKeys := slice "type" "format" "required" "min_length" "max_length" "minimum" "maximum" "integer" "pattern" "items" "min_items" "max_items" "validation_message" "placeholder_message" "help_message" -}}
  
  {{- range $attrName := $orderedKeys -}}
    {{- if isset $enriched $attrName -}}
      {{- $attrValue := index $enriched $attrName -}}
      
      {{/* Detect attribute source and override */}}
      {{- $attrSource := $fieldSource -}}
      {{- $attrTier := $fieldTier -}}
      {{- $isOverride := false -}}
      
      {{- if isset $baseConfig $fieldName -}}
        {{- $baseField := index $baseConfig $fieldName -}}
        {{- if isset $baseField $attrName -}}
          {{/* Attribute exists in base */}}
          {{- $baseValue := index $baseField $attrName -}}
          {{- if ne $baseValue $attrValue -}}
            {{/* Value differs - it's an override */}}
            {{- $attrSource = $moduleName -}}
            {{- $attrTier = "module" -}}
            {{- $isOverride = true -}}
          {{- end -}}
        {{- else -}}
          {{/* Attribute only in module */}}
          {{- $attrSource = $moduleName -}}
          {{- $attrTier = "module" -}}
        {{- end -}}
      {{- else -}}
        {{/* Field only in module */}}
        {{- $attrSource = $moduleName -}}
        {{- $attrTier = "module" -}}
      {{- end -}}
      
      {{/* Format value based on type */}}
      {{- $formatted := "" -}}
      {{- if eq (printf "%T" $attrValue) "bool" -}}
        {{- $formatted = printf "%t" $attrValue -}}
      {{- else if eq (printf "%T" $attrValue) "int" -}}
        {{- $formatted = printf "%d" $attrValue -}}
      {{- else if eq (printf "%T" $attrValue) "float64" -}}
        {{- $formatted = printf "%v" $attrValue -}}
      {{- else if reflect.IsSlice $attrValue -}}
        {{- $formatted = printf "%s" (jsonify $attrValue) -}}
      {{- else -}}
        {{- $formatted = printf "%q" $attrValue -}}
      {{- end -}}
      
      {{/* Build line with optional attribution */}}
      {{- if or (ne $attrSource $fieldSource) (ne $attrTier $fieldTier) -}}
        {{- $comment := printf "%s (%s)" $attrSource $attrTier -}}
        {{- if $isOverride -}}
          {{- $comment = printf "%s [override]" $comment -}}
        {{- end -}}
        {{- $yaml = $yaml | append (printf "    %s: %s  # %s" $attrName $formatted $comment) -}}
      {{- else -}}
        {{- $yaml = $yaml | append (printf "    %s: %s" $attrName $formatted) -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{/* Store result in scratch */}}
{{- $ctx.Scratch.Set "yaml_output" (delimit $yaml "\n") -}}
